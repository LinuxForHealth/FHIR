{"componentChunkName":"component---src-pages-guides-fhir-operation-framework-md","path":"/guides/FHIROperationFramework/","result":{"pageContext":{"frontmatter":{"layout":"default","title":"Extended Operations Framework","date":"2022-08-02T00:00:00.000Z"},"relativePagePath":"/guides/FHIROperationFramework.md","titleType":"append","MdxNode":{"id":"2d597dd9-bfcb-5191-952f-8300b5a973a4","children":[],"parent":"baecc19c-c84c-525a-92fc-c4171b0ff794","internal":{"content":"---\nlayout: default\ntitle: Extended Operations Framework\ndate:  2022-08-02\n---\n\n# Extended Operations Framework\n\nThe HL7 FHIR Specification describes a [framework](https://hl7.org/fhir/R4B/operations.html) for operations that go beyond the standard REST API.\n\nThis framework defines REST endpoints at three different levels.\n\nLevel | Example | Description\n--- | --- | ---\n**System** | https://my-server.com/fhir-server/api/v4/$convert | Convert from one format to another\n**Type** | https://my-server.com/fhir-server/api/v4/Patient/$export | Retrieve all the data from the Patient compartment\n**Instance** | https://my-server.com/fhir-server/api/v4/Patient/1-2-3-4/$export |Retrieve a specific Patient data from the Patient compartment data\n\nA list of operations supported by the LinuxForHealth FHIR Server is listed at https://linuxforhealth.github.io/FHIR/Conformance/#extended-operations\n\n## Calling an Operation\nThere are two types of operation invocation requests:\n- Complex (via POST)\n  - All operations can be invoked by passing a Parameters resource instance in the body of the request.\n  - For operations with no input parameters, no body is required.\n  - For operations with a single input parameter named “resource”, the Parameters wrapper can be omitted.\n- Simple (via GET)\n  - Operations with only primitive input parameters (i.e. no complex datatypes like ‘Identifier’ or ‘Reference’) can be invoked via HTTP GET by passing the parameters in the URL.\n\n### Example: Complex\n\n*Request*\n```sh\ncurl --location --request POST 'https://localhost:9443/fhir-server/api/v4/Patient/$validate' \\\n--header 'Authorization: Basic CHANGEME' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n \"resourceType\": \"Parameters\",\n \"parameter\": [\n  {\n   \"name\": \"resource\",\n   \"resource\": {\n    \"resourceType\": \"Patient\",\n    \"id\": \"example\",\n    \"name\": [\n     {\n      \"use\": \"official\",\n      \"family\": \"Chalmers\",\n      \"given\": [\"Peter\", \"James\"]\n     }\n    ]\n   }\n  }\n ]\n}'\n```\n\n*Response*\n```json\n{\n  \"resourceType\": \"OperationOutcome\",\n  \"id\": \"NoError\",\n  \"text\": {\n    \"status\": \"additional\",\n    \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"><p>No error</p></div>\"\n  },\n  \"issue\": [\n    {\n      \"severity\": \"warning\",\n      \"code\": \"invariant\",\n      \"details\": {\n        \"text\": \"dom-6: A resource should have narrative for robust management\"\n      },\n      \"expression\": [\n        \"Patient\"\n      ]\n    }\n  ]\n}\n```\n\n### Example: Simple\n\n*Request*\n``` sh\ncurl --location --request GET 'https://localhost:9443/fhir-server/api/v4/$healthcheck' \\\n--header 'Authorization: Basic CHANGEME' \\\n--header 'Content-Type: application/json'\n```\n\n*Response*\n``` json\n{\n  \"resourceType\": \"OperationOutcome\",\n  \"issue\": [\n    {\n      \"severity\": \"information\",\n      \"code\": \"informational\",\n      \"details\": {\n        \"text\": \"All OK\"\n      }\n    }\n  ]\n}\n```\n\n## Inspecting a FHIR Server’s Capability Statement (Operations)\nEach FHIR server is expected to advertise its System, Type, and Instance-level operations in a CapabilityStatement resource served from the `[base]/metadata` endpoint.\n\nTo check the Type and Instance operations, you can use this curl/jq command.\n\n`curl -k --location --request GET 'https://localhost:9443/fhir-server/api/v4/metadata' | jq -r '.rest[].resource[].operation[].name' | sort -u`\n\n```\napply\nclosure\nconvert\ndocument\nexpand\nexport\nlookup\nsubsumes\ntranslate\nvalidate\nvalidate-code\n```\n\nTo check the System Level operations, you can check using this curl/jq command.\n\n`curl -k --location --request GET 'https://localhost:9443/fhir-server/api/v4/metadata' | jq -r '.rest[].operation[].name'`\n\n```\nbulkdata-status\nclosure\nconvert\nexport\nhealthcheck\nhello\nimport\n```\n\n# The Specification in More Detail\n\nEach Operation per [the specification](https://hl7.org/fhir/R4B/operations.html#defining) is defined by an [OperationDefinition](https://hl7.org/fhir/R4B/operationdefinition.html) resource.\n\nThe elements needed are:\n- Unique Name of the Operation - `OperationDefinition.name`\n  - For instance, `\"name\": \"import\"`\n- Code used to activate the Operation - `OperationDefinition.code`\n  - For instance, `\"code\": \"import\"`\n  - The *code* is used in the CapabilityStatement.\n- The Context - System, Type, Instance - `OperationDefinition.system`, `Operation.type`, `Operation.instance`\n  - For instance, `\"system\": true`\n- Kind - always an `operation` - `OperationDefinition.kind`\n- Status - `OperationDefinition.status`, for implementers that are not intending to manage the lifecycle, best to put `draft`\n- Parameter - The list of parameters for the Operation - `OperationDefinition.parameter` - [Link](https://hl7.org/fhir/R4B/operationdefinition-definitions.html#OperationDefinition.parameter)\n  - Specificy your Query Parameter\n  - Be sure to have a return parameter\n  - Typically this is a FHIR Resource\n\n# The LinuxForHealth Extended Operations Framework implementation\n\nThe LinuxForHealth FHIR Server has integrated the Extended Operations Framework into the code base.\n\n![Framework](https://raw.githubusercontent.com/wiki/LinuxForHealth/FHIR/operation/operation-framework.png)\n\nOn startup, the FHIR Operation Registry uses the Java ServiceLoader framework. Each Operation is registered with the FHIROperationRegistry using `META-INF/services/com.ibm.fhir.server.operation.spi.FHIROperation` which lists each of the classes that implement the FHIROperation interface\n\nFor each implementation, the framework calls FHIROperation.getDefinition() to get the OperationDefinition and uses that do determine which endpoint to server the operation from (based on the defined operation levels, resource types, and \"code\").\n\nUpon receiving a request, the REST Layer checks to see if the JAX-RS path parameter `${operationName}` from a System, Type or Instance call is a registered Operation. If a FHIROperation exists in the registry with a \"code\" that matches the passed operationName, and it is valid for the level / resource type request, the framework calls FHIROperation.invoke() for that specific Operation type.\n\nTo make implementing custom operations easier, the LinuxForHealth FHIR Server provides an `AbstractOperation` class that provides input and output handling, while delegating to concrete implementations for the OperationDefinition and operation business logic.\n\nFor operations that are defined in the base FHIR specification, like [$validate](https://hl7.org/fhir/R4B/resource-operation-validate.html), the OperationDefinition can be retrieved from the built-in [FHIRRegistry](https://github.com/LinuxForHealth/FHIR/blob/6933926b8862d6515336f495e50ee7f66e5bcc15/operation/fhir-operation-validate/src/main/java/com/ibm/fhir/operation/validate/ValidateOperation.java#L40-L41).\n\nNote that once the Operation is loaded it is available until the server is restarted and redoes the ServiceLoader discovery.\n\n## Code Examples\nThere are a number of examples in the [LinuxForHealth/FHIR repo](https://github.com/LinuxForHealth/FHIR/tree/main/operation).\n\n## Installation of an Operation\nThe Operations are installed into the `userlib` folder of the LinuxForHealth FHIR Server. Some solutions are installing the operation as a layer in a docker image, or mount it as a volume.\n\n![install location](https://raw.githubusercontent.com/wiki/LinuxForHealth/FHIR/operation/installation-location.png)\n\n## Building a FHIR Operation\nTo build a FHIR Operation, a great starting point is the GitHub repo.\n\n1. Create a Maven Java project. Prefix the artifactid with `fhir-operation-` and give it a useful name, such as fhir-operation-myop.\n2. Add the relevant dependencies, such as `fhir-server`.\nThe pom.xml should look like:\n\n``` xml\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <artifactId>fhir-operation-myop</artifactId>\n\n    <parent>\n        <groupId>com.ibm.fhir</groupId>\n        <artifactId>fhir-parent</artifactId>\n        <version>4.4.1-SNAPSHOT</version>\n        <relativePath>../../fhir-parent</relativePath>\n    </parent>\n\n    <dependencies>\n        <dependency>\n  <groupId>${project.groupId}</groupId>\n  <artifactId>fhir-server</artifactId>\n  <version>${project.version}</version>\n        </dependency>\n    </dependencies>\n\n</project>\n```\n\nNote, if you are using the persistence layer, you naturally get the fhir-persistence libraries as a dependency.\nNote, if you are including some custom libraries or other libraries, you should shade the dependencies into a single jar or deliverable.\n\n3. Add your OperationDefinition to the `src/main/resources`, such as healthcare.json.\n4. Extend the AbstractOperation in your package, such as, `com.ibm.fhir.demo.MyOperation`\n5. Create the Services Loader file `com.ibm.fhir.server.operation.spi.FHIROperation` in `src/main/resources/META-INF/services/`\n6. Put a single line in the package for each of the Operations that are going to be hosted in the package.\n  ```\n  com.ibm.fhir.demo.MyOperation\n  com.ibm.fhir.demo.DemoOperation\n  ```\n7. Add the constructor, such as:\n``` java\n    public HealthcheckOperation() {\n        super();\n    }\n```\n\n8. In the class extending the AbstractOperation, override the `buildOperationDefinition()` to load the OperationDefinition (note you could use the OperationDefinition.Builder to generate the configuration).\n\n``` java\n    protected OperationDefinition buildOperationDefinition() {\n        try (InputStream in = getClass().getClassLoader().getResourceAsStream(\"healthcheck.json\")) {\n  return FHIRParser.parser(Format.JSON).parse(in);\n        } catch (Exception e) {\n  throw new Error(e);\n        }\n    }\n```\n\n9. Override the `doInvoke`.\n\n``` java\n@Override\n    protected Parameters doInvoke(FHIROperationContext operationContext, Class<? extends Resource> resourceType, String logicalId, String versionId, Parameters parameters, FHIRResourceHelpers resourceHelper) throws FHIROperationException {\n        // Do Business Logic\n    }\n```\n\n10. Implement your business logic using the invoke Parameters. Every request is secured by a user-group and has an associated tenant/user.\n\n| Method Parameter | How to use it |\n|------------|------------|\n| `FHIROperationContext operationContext` | If you need access to the URI, HTTP Headers, Request Properties, GET or POST (and subsequent) setting of a response status or body, these are used for decision making|\n| `Class<? extends Resource> resourceType` | If an instance or type call, this is non-null, and used to help the business logic make switches between different code paths |\n| `String logicalId` | If an instance call, this is non-null, and used to help the business logic make switches between different code paths |\n| `String versionId` | If an instance call, this is non-null, and used to help the business logic make switches between different code paths |\n| `Parameters parameters` | The input parameters used to trigger specific elements of the code path and used to help select outcomes |\n| `FHIRResourceHelpers resourceHelper` | Helper method to call Search using the REST interface (which is the easiest) |\n\n11. Return your response\n\n```\nreturn FHIROperationUtil.getOutputParameters(operationOutcome);\n```\n\nIf you return a single Resource in the Parameters object, the result is the single resource, such as a single OperationOutcome returned without the response Parameters.\n\n# Tips and Tricks\nThe following are some tips and tricks:\n\n## Length of Interaction\nThe framework is best suited for non-long poll requests such that an operation.\n\nIf you need to dispatch an operation, use two operations - one request operation, and one status/response operation.\n\n## Transactions\nIf you need to access the underlying persistence layer, you should request a transaction, and rollback or end it using on the FHIRPersistenceTransaction.\n\n``` java\n  FHIRPersistence pl =\n(FHIRPersistence) operationContext.getProperty(FHIROperationContext.PROPNAME_PERSISTENCE_IMPL);\n\n  FHIRPersistenceTransaction tx = resourceHelper.getTransaction();\n  tx.begin();\n\n  try {\n      // Do Operation\n      return FHIROperationUtil.getOutputParameters(operationOutcome);\n  } catch (Throwable t) {\n      tx.setRollbackOnly();\n      throw t;\n  } finally {\n      tx.end();\n  }\n```\n\nNaturally you'll have access to any persistence operation which includes the RESTful actions - create, read, _vread, search, et cetra.\n\n## Multitenancy\nBy default, all tenants have access to an operation. Each Operation, if it has a multi-tenant requirement, must uses the FHIRRequestContext to get access to the Tenant Id and make a decision based on the id.\n\n```\n  FHIRRequestContext ctx = FHIRRequestContext.get();\n  String tenantId = ctx.getTenantId();\n```\n\n## Mutating the Response Code and Non-FHIR Resource Type responses\n\nTo break out of the default response, use the `FHIROperationContext` which is ThreadSafe to mutate the Response.\n\n*Mutated Status*\n\n`operationContext.setProperty(FHIROperationContext.PROPNAME_STATUS_TYPE, Response.Status.ACCEPTED);`\n\n*Mutated Response* - Non-FHIR\n\n``` java\nResponse response = Response.status(Status.OK).entity(PollingLocationResponse.Writer.generate(pollingResponse)).type(MediaType.APPLICATION_JSON).build();\noperationContext.setProperty(FHIROperationContext.PROPNAME_RESPONSE, response);\n```\n\nYou can return null as a Parameters object - `return FHIROperationUtil.getOutputParameters(null);`\n\n# Questions and Support\nIf you need further support, you can reach out to the development team at:\n\n- [Zulip: LinuxForHealth](https://chat.fhir.org/#narrow/stream/212434-LinuxForHealth)\n- [GitHub: issues](https://github.com/LinuxForHealth/FHIR/issues)\n","type":"Mdx","contentDigest":"64662d881771c44a9768245f5f60e943","owner":"gatsby-plugin-mdx","counter":114,"fieldOwners":{"slug":"gatsby-plugin-slug"}},"frontmatter":{"title":"Extended Operations Framework","layout":"default","date":"2022-08-02T00:00:00.000Z"},"exports":{},"rawBody":"---\nlayout: default\ntitle: Extended Operations Framework\ndate:  2022-08-02\n---\n\n# Extended Operations Framework\n\nThe HL7 FHIR Specification describes a [framework](https://hl7.org/fhir/R4B/operations.html) for operations that go beyond the standard REST API.\n\nThis framework defines REST endpoints at three different levels.\n\nLevel | Example | Description\n--- | --- | ---\n**System** | https://my-server.com/fhir-server/api/v4/$convert | Convert from one format to another\n**Type** | https://my-server.com/fhir-server/api/v4/Patient/$export | Retrieve all the data from the Patient compartment\n**Instance** | https://my-server.com/fhir-server/api/v4/Patient/1-2-3-4/$export |Retrieve a specific Patient data from the Patient compartment data\n\nA list of operations supported by the LinuxForHealth FHIR Server is listed at https://linuxforhealth.github.io/FHIR/Conformance/#extended-operations\n\n## Calling an Operation\nThere are two types of operation invocation requests:\n- Complex (via POST)\n  - All operations can be invoked by passing a Parameters resource instance in the body of the request.\n  - For operations with no input parameters, no body is required.\n  - For operations with a single input parameter named “resource”, the Parameters wrapper can be omitted.\n- Simple (via GET)\n  - Operations with only primitive input parameters (i.e. no complex datatypes like ‘Identifier’ or ‘Reference’) can be invoked via HTTP GET by passing the parameters in the URL.\n\n### Example: Complex\n\n*Request*\n```sh\ncurl --location --request POST 'https://localhost:9443/fhir-server/api/v4/Patient/$validate' \\\n--header 'Authorization: Basic CHANGEME' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n \"resourceType\": \"Parameters\",\n \"parameter\": [\n  {\n   \"name\": \"resource\",\n   \"resource\": {\n    \"resourceType\": \"Patient\",\n    \"id\": \"example\",\n    \"name\": [\n     {\n      \"use\": \"official\",\n      \"family\": \"Chalmers\",\n      \"given\": [\"Peter\", \"James\"]\n     }\n    ]\n   }\n  }\n ]\n}'\n```\n\n*Response*\n```json\n{\n  \"resourceType\": \"OperationOutcome\",\n  \"id\": \"NoError\",\n  \"text\": {\n    \"status\": \"additional\",\n    \"div\": \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"><p>No error</p></div>\"\n  },\n  \"issue\": [\n    {\n      \"severity\": \"warning\",\n      \"code\": \"invariant\",\n      \"details\": {\n        \"text\": \"dom-6: A resource should have narrative for robust management\"\n      },\n      \"expression\": [\n        \"Patient\"\n      ]\n    }\n  ]\n}\n```\n\n### Example: Simple\n\n*Request*\n``` sh\ncurl --location --request GET 'https://localhost:9443/fhir-server/api/v4/$healthcheck' \\\n--header 'Authorization: Basic CHANGEME' \\\n--header 'Content-Type: application/json'\n```\n\n*Response*\n``` json\n{\n  \"resourceType\": \"OperationOutcome\",\n  \"issue\": [\n    {\n      \"severity\": \"information\",\n      \"code\": \"informational\",\n      \"details\": {\n        \"text\": \"All OK\"\n      }\n    }\n  ]\n}\n```\n\n## Inspecting a FHIR Server’s Capability Statement (Operations)\nEach FHIR server is expected to advertise its System, Type, and Instance-level operations in a CapabilityStatement resource served from the `[base]/metadata` endpoint.\n\nTo check the Type and Instance operations, you can use this curl/jq command.\n\n`curl -k --location --request GET 'https://localhost:9443/fhir-server/api/v4/metadata' | jq -r '.rest[].resource[].operation[].name' | sort -u`\n\n```\napply\nclosure\nconvert\ndocument\nexpand\nexport\nlookup\nsubsumes\ntranslate\nvalidate\nvalidate-code\n```\n\nTo check the System Level operations, you can check using this curl/jq command.\n\n`curl -k --location --request GET 'https://localhost:9443/fhir-server/api/v4/metadata' | jq -r '.rest[].operation[].name'`\n\n```\nbulkdata-status\nclosure\nconvert\nexport\nhealthcheck\nhello\nimport\n```\n\n# The Specification in More Detail\n\nEach Operation per [the specification](https://hl7.org/fhir/R4B/operations.html#defining) is defined by an [OperationDefinition](https://hl7.org/fhir/R4B/operationdefinition.html) resource.\n\nThe elements needed are:\n- Unique Name of the Operation - `OperationDefinition.name`\n  - For instance, `\"name\": \"import\"`\n- Code used to activate the Operation - `OperationDefinition.code`\n  - For instance, `\"code\": \"import\"`\n  - The *code* is used in the CapabilityStatement.\n- The Context - System, Type, Instance - `OperationDefinition.system`, `Operation.type`, `Operation.instance`\n  - For instance, `\"system\": true`\n- Kind - always an `operation` - `OperationDefinition.kind`\n- Status - `OperationDefinition.status`, for implementers that are not intending to manage the lifecycle, best to put `draft`\n- Parameter - The list of parameters for the Operation - `OperationDefinition.parameter` - [Link](https://hl7.org/fhir/R4B/operationdefinition-definitions.html#OperationDefinition.parameter)\n  - Specificy your Query Parameter\n  - Be sure to have a return parameter\n  - Typically this is a FHIR Resource\n\n# The LinuxForHealth Extended Operations Framework implementation\n\nThe LinuxForHealth FHIR Server has integrated the Extended Operations Framework into the code base.\n\n![Framework](https://raw.githubusercontent.com/wiki/LinuxForHealth/FHIR/operation/operation-framework.png)\n\nOn startup, the FHIR Operation Registry uses the Java ServiceLoader framework. Each Operation is registered with the FHIROperationRegistry using `META-INF/services/com.ibm.fhir.server.operation.spi.FHIROperation` which lists each of the classes that implement the FHIROperation interface\n\nFor each implementation, the framework calls FHIROperation.getDefinition() to get the OperationDefinition and uses that do determine which endpoint to server the operation from (based on the defined operation levels, resource types, and \"code\").\n\nUpon receiving a request, the REST Layer checks to see if the JAX-RS path parameter `${operationName}` from a System, Type or Instance call is a registered Operation. If a FHIROperation exists in the registry with a \"code\" that matches the passed operationName, and it is valid for the level / resource type request, the framework calls FHIROperation.invoke() for that specific Operation type.\n\nTo make implementing custom operations easier, the LinuxForHealth FHIR Server provides an `AbstractOperation` class that provides input and output handling, while delegating to concrete implementations for the OperationDefinition and operation business logic.\n\nFor operations that are defined in the base FHIR specification, like [$validate](https://hl7.org/fhir/R4B/resource-operation-validate.html), the OperationDefinition can be retrieved from the built-in [FHIRRegistry](https://github.com/LinuxForHealth/FHIR/blob/6933926b8862d6515336f495e50ee7f66e5bcc15/operation/fhir-operation-validate/src/main/java/com/ibm/fhir/operation/validate/ValidateOperation.java#L40-L41).\n\nNote that once the Operation is loaded it is available until the server is restarted and redoes the ServiceLoader discovery.\n\n## Code Examples\nThere are a number of examples in the [LinuxForHealth/FHIR repo](https://github.com/LinuxForHealth/FHIR/tree/main/operation).\n\n## Installation of an Operation\nThe Operations are installed into the `userlib` folder of the LinuxForHealth FHIR Server. Some solutions are installing the operation as a layer in a docker image, or mount it as a volume.\n\n![install location](https://raw.githubusercontent.com/wiki/LinuxForHealth/FHIR/operation/installation-location.png)\n\n## Building a FHIR Operation\nTo build a FHIR Operation, a great starting point is the GitHub repo.\n\n1. Create a Maven Java project. Prefix the artifactid with `fhir-operation-` and give it a useful name, such as fhir-operation-myop.\n2. Add the relevant dependencies, such as `fhir-server`.\nThe pom.xml should look like:\n\n``` xml\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <artifactId>fhir-operation-myop</artifactId>\n\n    <parent>\n        <groupId>com.ibm.fhir</groupId>\n        <artifactId>fhir-parent</artifactId>\n        <version>4.4.1-SNAPSHOT</version>\n        <relativePath>../../fhir-parent</relativePath>\n    </parent>\n\n    <dependencies>\n        <dependency>\n  <groupId>${project.groupId}</groupId>\n  <artifactId>fhir-server</artifactId>\n  <version>${project.version}</version>\n        </dependency>\n    </dependencies>\n\n</project>\n```\n\nNote, if you are using the persistence layer, you naturally get the fhir-persistence libraries as a dependency.\nNote, if you are including some custom libraries or other libraries, you should shade the dependencies into a single jar or deliverable.\n\n3. Add your OperationDefinition to the `src/main/resources`, such as healthcare.json.\n4. Extend the AbstractOperation in your package, such as, `com.ibm.fhir.demo.MyOperation`\n5. Create the Services Loader file `com.ibm.fhir.server.operation.spi.FHIROperation` in `src/main/resources/META-INF/services/`\n6. Put a single line in the package for each of the Operations that are going to be hosted in the package.\n  ```\n  com.ibm.fhir.demo.MyOperation\n  com.ibm.fhir.demo.DemoOperation\n  ```\n7. Add the constructor, such as:\n``` java\n    public HealthcheckOperation() {\n        super();\n    }\n```\n\n8. In the class extending the AbstractOperation, override the `buildOperationDefinition()` to load the OperationDefinition (note you could use the OperationDefinition.Builder to generate the configuration).\n\n``` java\n    protected OperationDefinition buildOperationDefinition() {\n        try (InputStream in = getClass().getClassLoader().getResourceAsStream(\"healthcheck.json\")) {\n  return FHIRParser.parser(Format.JSON).parse(in);\n        } catch (Exception e) {\n  throw new Error(e);\n        }\n    }\n```\n\n9. Override the `doInvoke`.\n\n``` java\n@Override\n    protected Parameters doInvoke(FHIROperationContext operationContext, Class<? extends Resource> resourceType, String logicalId, String versionId, Parameters parameters, FHIRResourceHelpers resourceHelper) throws FHIROperationException {\n        // Do Business Logic\n    }\n```\n\n10. Implement your business logic using the invoke Parameters. Every request is secured by a user-group and has an associated tenant/user.\n\n| Method Parameter | How to use it |\n|------------|------------|\n| `FHIROperationContext operationContext` | If you need access to the URI, HTTP Headers, Request Properties, GET or POST (and subsequent) setting of a response status or body, these are used for decision making|\n| `Class<? extends Resource> resourceType` | If an instance or type call, this is non-null, and used to help the business logic make switches between different code paths |\n| `String logicalId` | If an instance call, this is non-null, and used to help the business logic make switches between different code paths |\n| `String versionId` | If an instance call, this is non-null, and used to help the business logic make switches between different code paths |\n| `Parameters parameters` | The input parameters used to trigger specific elements of the code path and used to help select outcomes |\n| `FHIRResourceHelpers resourceHelper` | Helper method to call Search using the REST interface (which is the easiest) |\n\n11. Return your response\n\n```\nreturn FHIROperationUtil.getOutputParameters(operationOutcome);\n```\n\nIf you return a single Resource in the Parameters object, the result is the single resource, such as a single OperationOutcome returned without the response Parameters.\n\n# Tips and Tricks\nThe following are some tips and tricks:\n\n## Length of Interaction\nThe framework is best suited for non-long poll requests such that an operation.\n\nIf you need to dispatch an operation, use two operations - one request operation, and one status/response operation.\n\n## Transactions\nIf you need to access the underlying persistence layer, you should request a transaction, and rollback or end it using on the FHIRPersistenceTransaction.\n\n``` java\n  FHIRPersistence pl =\n(FHIRPersistence) operationContext.getProperty(FHIROperationContext.PROPNAME_PERSISTENCE_IMPL);\n\n  FHIRPersistenceTransaction tx = resourceHelper.getTransaction();\n  tx.begin();\n\n  try {\n      // Do Operation\n      return FHIROperationUtil.getOutputParameters(operationOutcome);\n  } catch (Throwable t) {\n      tx.setRollbackOnly();\n      throw t;\n  } finally {\n      tx.end();\n  }\n```\n\nNaturally you'll have access to any persistence operation which includes the RESTful actions - create, read, _vread, search, et cetra.\n\n## Multitenancy\nBy default, all tenants have access to an operation. Each Operation, if it has a multi-tenant requirement, must uses the FHIRRequestContext to get access to the Tenant Id and make a decision based on the id.\n\n```\n  FHIRRequestContext ctx = FHIRRequestContext.get();\n  String tenantId = ctx.getTenantId();\n```\n\n## Mutating the Response Code and Non-FHIR Resource Type responses\n\nTo break out of the default response, use the `FHIROperationContext` which is ThreadSafe to mutate the Response.\n\n*Mutated Status*\n\n`operationContext.setProperty(FHIROperationContext.PROPNAME_STATUS_TYPE, Response.Status.ACCEPTED);`\n\n*Mutated Response* - Non-FHIR\n\n``` java\nResponse response = Response.status(Status.OK).entity(PollingLocationResponse.Writer.generate(pollingResponse)).type(MediaType.APPLICATION_JSON).build();\noperationContext.setProperty(FHIROperationContext.PROPNAME_RESPONSE, response);\n```\n\nYou can return null as a Parameters object - `return FHIROperationUtil.getOutputParameters(null);`\n\n# Questions and Support\nIf you need further support, you can reach out to the development team at:\n\n- [Zulip: LinuxForHealth](https://chat.fhir.org/#narrow/stream/212434-LinuxForHealth)\n- [GitHub: issues](https://github.com/LinuxForHealth/FHIR/issues)\n","fileAbsolutePath":"/home/runner/work/FHIR/FHIR/fhir/docs/src/pages/guides/FHIROperationFramework.md","fields":{"slug":"/guides/FHIROperationFramework"}}}},"staticQueryHashes":["1364590287","2102389209","2102389209","227138135","227138135","2456312558","2746626797","2746626797","3018647132","3018647132","3906363820","3906363820","768070550"]}